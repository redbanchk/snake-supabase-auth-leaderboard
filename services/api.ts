import { supabase } from '../supabase/client'
import type { Tables, TablesInsert } from '../supabase/types'
export type GameMode = 'classic' | 'time_attack' | 'obstacles'
export async function getCurrentUser() { const { data, error } = await supabase.auth.getUser(); if (error) throw error; return data.user }
export async function upsertProfile(input: { username: string; avatar_url?: string; country_code?: string }): Promise<Tables<'profiles'>[]> { const user = await getCurrentUser(); if (!user) throw new Error('Not authenticated'); const username = input.username.trim(); if (!username) throw new Error('Invalid username'); const payload: TablesInsert<'profiles'> = { id: user.id, username, avatar_url: input.avatar_url ?? null, country_code: input.country_code ?? null, }; const { data, error } = await supabase.from('profiles').upsert(payload).select('id, username, avatar_url, country_code, created_at'); if (error) throw error; return data }
export async function submitScore(score: number, options?: { mode?: GameMode; duration_seconds?: number; grid_size?: number }): Promise<Tables<'scores'>[]> { const user = await getCurrentUser(); if (!user) throw new Error('Not authenticated'); const mode = options?.mode ?? 'classic'; if (mode !== 'classic' && mode !== 'time_attack' && mode !== 'obstacles') throw new Error('Invalid mode'); const payload: TablesInsert<'scores'> = { user_id: user.id, score, mode, duration_seconds: options?.duration_seconds ?? null, grid_size: options?.grid_size ?? null, }; const { data, error } = await supabase.from('scores').insert(payload).select('id, user_id, score, mode, duration_seconds, grid_size, created_at'); if (error) throw error; return data }
export async function getGlobalLeaderboard(params?: { limit?: number; offset?: number }) { const limit = params?.limit ?? 100; const offset = params?.offset ?? 0; const { data, error } = await supabase.from('leaderboard_global').select('rank, user_id, username, best_score').order('best_score', { ascending: false }).range(offset, offset + limit - 1); if (error) throw error; return data as Tables<'leaderboard_global'>[] }
export async function getModeLeaderboard(mode: GameMode, params?: { limit?: number; offset?: number }) { const limit = params?.limit ?? 100; const offset = params?.offset ?? 0; const { data, error } = await supabase.from('leaderboard').select('user_id, username, avatar_url, country_code, mode, best_score, rank').eq('mode', mode).order('best_score', { ascending: false }).range(offset, offset + limit - 1); if (error) throw error; return data as Tables<'leaderboard'>[] }
